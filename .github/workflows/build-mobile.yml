name: Build iOS App

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Dependencies (optional)
      run: brew install cocoapods || true

    # 1️⃣ 컴파일 단계
    - name: Compile mobile.m to arm64
      run: |
        clang -arch arm64 -fobjc-arc \
              -isysroot $(xcrun --sdk iphoneos --show-sdk-path) \
              C/mobile.m -o build/mobile_arm64

    # 2️⃣ 서명 단계
    - name: Import P12 and Provisioning
      run: |
        security import sign/cert.p12 -k ~/Library/Keychains/login.keychain -P "${{ secrets.P12_PASSWORD }}"
        cp sign/profile.mobileprovision build/profile.mobileprovision

    - name: Code Sign
      run: |
        codesign -f -s "iPhone Developer: 준호" \
                 --entitlements build/mobile.entitlements \
                 build/mobile_arm64

    # 3️⃣ .ipa 패키징
    - name: Package IPA
      run: |
        mkdir -p Payload/Mobile.app
        cp build/mobile_arm64 Payload/Mobile.app/
        cp build/profile.mobileprovision Payload/Mobile.app/
        zip -r build/Mobile.ipa Payload
        ls -l build/
    
    - name: Upload IPA as artifact
      uses: actions/upload-artifact@v3
      with:
        name: Mobile-IPA
        path: build/Mobile.ipa
